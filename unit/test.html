<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Clash of Empires Tests</title>
    <link rel="stylesheet" href="qunit-1.13.0.css">
    <script src="../lib/socket.io.js"></script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../client/controller/inputListeners.js"></script>
    <script src="../client/DataConnection.js"></script>
    <script src="../client/view/Display.js"></script>
    <script src="../client/view/ScoreDisplay.js"></script>
    <script src="../client/view/TitleDisplay.js"></script>

    <script src="../server/GameMap.js"></script>
    <script src="../server/Region.js"></script>
    <script src="../server/Point.js"></script>
    <script src="../server/Player.js"></script>
    <script src="../server/maps/Europe.js"></script>

    <script src="../client/view/MapDisplay.js"></script>


</head>
<body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="qunit-1.13.0.js"></script>




    <script>

        test("Region test",function(){
            var reg=new Region(2,2,2);
            var p=new Player(1);
            reg.setOwner(p);
            ok(reg.getOwner()!=undefined);
            ok(reg.getRenderState()!==null,"Region can be rendered");
            ok(reg.getX()==2,"xPos:"+reg.getX());
            ok(reg.getY()==2,"yPos"+reg.getY());
            ok(reg.getSize()==2,"Region size:"+reg.getSize());

            var reg2=new Region(2,3,2);
            ok(reg2.distance(reg)===1,"Testing region distance");
            reg.addBorder(reg2);
            reg2.addBorder(reg);
            ok(reg2.hasBorder(reg)===true,"Has border");
            ok(reg.hasBorder(reg2)===true,"Has border");
            ok(reg.getBorders().length===1,"Testing correct border count:");
            ok(reg2.getBorders().length===1,"Testing correct border count");
        });

        test("Region render state test",function(){
            var reg=new Region(2,2,2);
            var p=new Player(1);
            reg.setOwner(p);
            var renderState=reg.getRenderState();
            ok(renderState.getOwner()>-1&&renderState.getOwner()<10,"Testing owner");
            ok(renderState.getX()==2,"Correct xPos state");
            ok(renderState.getY()==2,"Correct yPos state");
            ok(renderState.getSize()==2,"Region size state:"+renderState.getSize());
        });

        test( "DataConnection test", function() {
            var dCon=new LocalConnection();
            var data=dCon.getRegionStates();
            ok( 1, "Passed!" );
        });

        test("Map setup tests",function(){
            var mapGen=new Europe();
            var data=mapGen.generateMap();
            var regions=data["regions"];
            var players=data["players"];
            players.forEach(function(player){
                ok(player!==null,"Checking if player is null");
            });
            regions.forEach(function(reg){
                if(reg===undefined){
                    ok(0,"Undefined region");
                }
                if(reg.getOwner()===null){
                    ok(0,"Null owner");
                }
                if(reg.getBorders().length===0){
                    ok(0,"No borders");
                }
            });
        });

        test("Game map tests",function(){

            var map=new GameMap();

            ok(map.getRegionCount()>0,"Regions created");
            ok(map.getRegionCount()<999999,"Did not create too many regions");
            map.updateState().forEach(function(state){
                if(isNaN(state["army"])){
                    ok(0,"Army state is invalid");
                }
            });
        });

        test("Point tests",function(){
            var p=new Point(1,1);
            ok(p.getX()===1,"Testing xPos");
            ok(p.getY()===1,"Testing yPos");

            var p2=new Point(1,1);
            ok(p.getDistance(p2)==0,"Testing distance to same location");

            var p3=new Point(2,1);
            ok(p.getDistance(p3)===1,"Testing distance");

            var p4=new Point(50,1);
            ok(p.getDistance(p4)==49,"Testing distance:"+ p.getDistance(p4));

            var p5=new Point(4,5);
            ok(p.getDistance(p5)===5,"Testing distance:"+ p.getDistance(p5));
        });

        test("Player tests",function(){

            var r0=new Region(200,200.1);
            var r1=new Region(0,0,1);
            var r2=new Region(100,100,1);

            var p1=new Player(1,NoAI);
            var p2=new Player(2,NoAI);

            r0.setOwner(p1);
            r1.setOwner(p1);
            r2.setOwner(p2);

            p1.addTroops(r0,50);
            p1.addTroops(r1,200);
            p2.addTroops(r2,100);

            ok(p1.getArmy(r0)===50);
            ok(p1.getArmy(r1)===200,"Army size:"+p1.getArmy(r1));
            ok(p1.getArmy(r2)===0,"Army size:"+p1.getArmy(r2));
            ok(p2.getArmy(r2)===100,"Army size:"+p1.getArmy(r2));

            var move=new MoveCommand(r1,r2);
            while(r2.getOwner()!==p1){
                move.execute(p1);
            }
            ok(r1.getOwner()===p1,"Player still has old region");

            move.execute(p1);
            ok(p1.getArmy(r1)<150,"Army size:"+p1.getArmy(r1));
            ok(p1.getArmy(r1)>10,"Army size:"+p1.getArmy(r1));
            ok(p1.getArmy(r2)>0,"Size of army in conquered region:"+p1.getArmy(r2));
            ok(p2.getArmy(r2)===0,"Army size"+p2.getArmy(r2));



        });


    </script>

</body>
</html>